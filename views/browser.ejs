<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> | MongoDB Dashboard</title>
    <script>
      (function () {
        try {
          const theme =
            localStorage.getItem("mongodb_dashboard_theme") || "system";
          document.documentElement.setAttribute("data-theme", theme);
        } catch (e) {
          document.documentElement.setAttribute("data-theme", "system");
        }
      })();
    </script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <header class="header">
      <a href="/" class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
          />
        </svg>
        MongoDB Dashboard
      </a>
      <nav class="nav">
        <a href="/databases" class="nav-link">Databases</a>
        <span class="nav-sep">/</span>
        <a href="/browse/<%= dbName %>" class="nav-link"><%= dbName %></a>
        <% if (activeCollection) { %>
        <span class="nav-sep">/</span>
        <span class="nav-current"><%= activeCollection %></span>
        <% } %>
      </nav>
      <div class="header-actions">
        <div class="theme-toggle">
          <button class="theme-toggle-btn" title="Theme">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
            <span class="theme-toggle-text">System</span>
          </button>
          <div class="theme-dropdown">
            <div class="theme-option active" data-theme="system">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                />
              </svg>
              <span>System</span>
            </div>
            <div class="theme-option" data-theme="light">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <span>Light</span>
            </div>
            <div class="theme-option" data-theme="dark">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
              <span>Dark</span>
            </div>
          </div>
        </div>
        <button
          id="disconnectBtn"
          class="btn btn-sm btn-ghost"
          title="Disconnect"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"
            />
          </svg>
        </button>
      </div>
    </header>

    <main class="main">
      <div class="browser-layout">
        <aside class="sidebar">
          <div class="sidebar-header">
            <h2>Collections</h2>
            <span class="collection-count"><%= collections.length %></span>
          </div>
          <nav class="collection-list">
            <% collections.forEach(function(col) { %>
            <a
              href="/browse/<%= dbName %>/<%= col.name %>"
              class="collection-item <%= activeCollection === col.name ? 'active' : '' %>"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                />
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
              </svg>
              <span class="collection-name"><%= col.name %></span>
              <span class="collection-doc-count" data-count="<%= col.count %>"
                ><%= col.count %></span
              >
            </a>
            <% }); %>
          </nav>
        </aside>

        <div class="content">
          <% if (activeCollection) { %>
          <div class="content-header">
            <div class="content-title">
              <h2><%= activeCollection %></h2>
              <span id="docCount" class="doc-count"></span>
            </div>
            <div class="content-search">
              <div class="search-input-wrapper">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  class="search-icon"
                >
                  <circle cx="11" cy="11" r="8" />
                  <path d="M21 21l-4.35-4.35" />
                </svg>
                <input
                  type="text"
                  id="searchInput"
                  class="search-input"
                  placeholder="Search all fields..."
                  autocomplete="off"
                />
                <button
                  id="clearSearchBtn"
                  class="search-clear"
                  style="display: none"
                  title="Clear search"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M18 6L6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
            <div class="content-actions">
              <button
                id="columnsBtn"
                class="btn btn-ghost"
                title="Select Columns"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 3h18v18H3zM3 9h18M9 3v18" />
                </svg>
                Columns
              </button>
              <button id="refreshBtn" class="btn btn-ghost" title="Refresh">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M23 4v6h-6M1 20v-6h6" />
                  <path
                    d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"
                  />
                </svg>
              </button>
              <button id="addDocBtn" class="btn btn-primary">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M12 5v14M5 12h14" />
                </svg>
                Add Document
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="data-table" id="dataTable">
              <thead>
                <tr id="tableHeader"></tr>
              </thead>
              <tbody id="tableBody">
                <tr class="loading-row">
                  <td colspan="100">
                    <div class="loading-spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="pagination" style="display: none">
            <button id="loadMoreBtn" class="btn btn-ghost">Load More</button>
            <span id="paginationInfo" class="pagination-info"></span>
          </div>
          <% } else { %>
          <div class="empty-state">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1"
            >
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
              <path d="M14 2v6h6" />
            </svg>
            <h3>Select a Collection</h3>
            <p>Choose a collection from the sidebar to browse documents</p>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Document Modal -->
      <div id="docModal" class="modal" style="display: none">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modalTitle">Document</h3>
            <button class="modal-close" id="modalClose">&times;</button>
          </div>
          <div class="modal-body">
            <div id="formToggle" class="form-toggle" style="display: none">
              <button id="useFormBtn" class="btn btn-sm btn-ghost active">
                Form
              </button>
              <button id="useJsonBtn" class="btn btn-sm btn-ghost">JSON</button>
            </div>
            <div id="docFormContainer" style="display: none"></div>
            <textarea
              id="docEditor"
              class="doc-editor"
              spellcheck="false"
            ></textarea>
            <p id="editorError" class="error-message" style="display: none"></p>
          </div>
          <div class="modal-footer">
            <button id="modalCancel" class="btn btn-ghost">Cancel</button>
            <button
              id="modalDelete"
              class="btn btn-danger"
              style="display: none"
            >
              Delete
            </button>
            <button id="modalSave" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteModal" class="modal" style="display: none">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-sm">
          <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button class="modal-close" id="deleteModalClose">&times;</button>
          </div>
          <div class="modal-body">
            <p>
              Are you sure you want to delete this document? This action cannot
              be undone.
            </p>
          </div>
          <div class="modal-footer">
            <button id="deleteCancel" class="btn btn-ghost">Cancel</button>
            <button id="deleteConfirm" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>

      <!-- Column Selector Modal -->
      <div id="columnsModal" class="modal" style="display: none">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-sm">
          <div class="modal-header">
            <h3>Select Columns</h3>
            <button class="modal-close" id="columnsModalClose">&times;</button>
          </div>
          <div class="modal-body">
            <div class="columns-selector">
              <div class="columns-actions">
                <button id="selectAllColumns" class="btn btn-sm btn-ghost">
                  Select All
                </button>
                <button id="deselectAllColumns" class="btn btn-sm btn-ghost">
                  Deselect All
                </button>
              </div>
              <div id="columnsList" class="columns-list"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="columnsCancel" class="btn btn-ghost">Cancel</button>
            <button id="columnsApply" class="btn btn-primary">Apply</button>
          </div>
        </div>
      </div>

      <!-- View Document Modal -->
      <div id="viewModal" class="modal" style="display: none">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-lg">
          <div class="modal-header">
            <h3>View Document</h3>
            <button class="modal-close" id="viewModalClose">&times;</button>
          </div>
          <div class="modal-body">
            <div id="viewDocumentContent" class="json-viewer">
              <div class="loading-spinner"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="viewModalPopulateBtn" class="btn btn-primary">Populate</button>
            <button id="viewModalCloseBtn" class="btn btn-ghost">Close</button>
          </div>
        </div>
      </div>
    </main>

    <script src="/js/app.js"></script>
    <script>
      // Format collection counts
      document.querySelectorAll(".collection-doc-count").forEach((el) => {
        const count = parseInt(el.dataset.count);
        if (!isNaN(count)) {
          el.textContent = formatCount(count);
        }
      });

      const dbName = "<%= dbName %>";
      const activeCollection = '<%= activeCollection || "" %>';
      if (activeCollection) {
        initBrowser(dbName, activeCollection);
      }
    </script>
  </body>
</html>
